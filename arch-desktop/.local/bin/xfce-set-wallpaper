#!/usr/bin/env bash
set -euo pipefail

LOG="${HOME}/.xfce-set-wallpaper.log"
exec >>"$LOG" 2>&1

echo "-----"
date
echo "cmd: $0 $*"
echo "DISPLAY=${DISPLAY-}"
echo "XDG_CURRENT_DESKTOP=${XDG_CURRENT_DESKTOP-}"
echo "DBUS_SESSION_BUS_ADDRESS=${DBUS_SESSION_BUS_ADDRESS-}"

WP="${HOME}/.local/share/wallpapers/gruvbox_arch.png"
[[ -f "$WP" ]] || { echo "Wallpaper not found: $WP"; exit 1; }

deadline=$((SECONDS + 30))
while (( SECONDS < deadline )); do
  if xfconf-query -c xfce4-desktop -l 2>/dev/null | grep -qE '/backdrop/'; then
    break
  fi
  sleep 0.25
done

props="$(xfconf-query -c xfce4-desktop -l 2>/dev/null | grep -E '/backdrop/.*(/image-path|/last-image)$' || true)"
if [[ -z "${props}" ]]; then
  echo "No XFCE backdrop properties found (xfdesktop not ready?)."
  exit 0
fi

while IFS= read -r prop; do
  echo "set: $prop -> $WP"
  xfconf-query -c xfce4-desktop -p "$prop" -s "$WP" || true
done <<< "${props}"

styles="$(xfconf-query -c xfce4-desktop -l 2>/dev/null | grep -E '/backdrop/.*(/image-style)$' || true)"
while IFS= read -r prop; do
  [[ -n "$prop" ]] || continue
  echo "style: $prop -> 5"
  xfconf-query -c xfce4-desktop -p "$prop" -s 5 >/dev/null 2>&1 || true
done <<< "${styles}"

echo "OK"
