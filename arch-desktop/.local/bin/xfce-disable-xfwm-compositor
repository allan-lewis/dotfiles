#!/usr/bin/env bash
set -euo pipefail

LOG="${HOME}/.xfce-disable-xfwm-compositor.log"
exec >>"$LOG" 2>&1

echo "-----"
date
echo "cmd: $0 $*"
echo "DISPLAY=${DISPLAY-}"
echo "XDG_CURRENT_DESKTOP=${XDG_CURRENT_DESKTOP-}"
echo "DBUS_SESSION_BUS_ADDRESS=${DBUS_SESSION_BUS_ADDRESS-}"

deadline=$((SECONDS + 20))
while (( SECONDS < deadline )); do
  if xfconf-query -c xfwm4 -p /general/use_compositing >/dev/null 2>&1; then
    break
  fi
  sleep 0.25
done

echo "setting xfwm4 compositing -> false"
xfconf-query -c xfwm4 -p /general/use_compositing -s false || true
echo "current:"
xfconf-query -c xfwm4 -p /general/use_compositing || true
echo "OK"
