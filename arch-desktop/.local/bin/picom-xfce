#!/usr/bin/env bash
set -euo pipefail

LOG="${HOME}/.picom-xfce.log"
exec >>"$LOG" 2>&1

echo "-----"
date
echo "cmd: $0 $*"
echo "DISPLAY=${DISPLAY-}"
echo "XDG_CURRENT_DESKTOP=${XDG_CURRENT_DESKTOP-}"
echo "DBUS_SESSION_BUS_ADDRESS=${DBUS_SESSION_BUS_ADDRESS-}"

deadline=$((SECONDS + 25))
while (( SECONDS < deadline )); do
  if [[ -n "${DISPLAY:-}" ]] && pgrep -x xfwm4 >/dev/null 2>&1; then
    break
  fi
  sleep 0.25
done

echo "ensure xfwm4 compositing -> false"
xfconf-query -c xfwm4 -p /general/use_compositing -s false >/dev/null 2>&1 || true

echo "kill existing picom (if any)"
pkill picom >/dev/null 2>&1 || true

echo "check composite owner before start:"
xprop -root _NET_WM_CM_S0 2>/dev/null || true

echo "starting picom..."
picom --backend glx --vsync --xrender-sync-fence --no-use-damage
rc=$?

echo "picom exited rc=$rc"
echo "check composite owner after:"
xprop -root _NET_WM_CM_S0 2>/dev/null || true

exit "$rc"
